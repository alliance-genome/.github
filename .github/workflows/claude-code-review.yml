name: Claude Code Review (Reusable)

on:
  workflow_call:
    inputs:
      model:
        description: 'Claude model to use. If empty, falls back to CLAUDE_PR_REVIEW_MODEL org/repo variable.'
        required: false
        default: ''
        type: string
      max_turns:
        description: 'Maximum conversation turns'
        required: false
        default: '10'
        type: string
      review_focus:
        description: 'What to focus the review on'
        required: false
        default: 'correctness, bugs, and security'
        type: string
      trigger_phrase:
        description: 'Phrase to trigger manual reviews'
        required: false
        default: '@claude'
        type: string
      skip_threshold:
        description: 'Line count threshold to skip reviews entirely (0=disable skip)'
        required: false
        default: '3'
        type: string
    secrets:
      ANTHROPIC_API_KEY:
        description: 'Anthropic API key for Claude'
        required: true

jobs:
  claude-review:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    if: |
      github.actor != 'pjhale' &&
      github.actor != 'claude[bot]' && (
        github.event_name == 'pull_request' ||
        (github.event_name == 'issue_comment' && contains(github.event.comment.body, inputs.trigger_phrase)) ||
        github.event_name == 'workflow_dispatch'
      )

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Calculate PR size and skip trivial changes
        id: pr_size
        if: github.event_name == 'pull_request'
        run: |
          set -eo pipefail
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          DIFF_STATS=$(git diff --numstat "$BASE_SHA".."$HEAD_SHA" | grep -E '^[0-9]+\s+[0-9]+' || true)
          TOTAL=$(echo "$DIFF_STATS" | awk '{s+=$1+$2} END {print s+0}')
          echo "total_changes=$TOTAL" >> $GITHUB_OUTPUT
          if (( 10#${TOTAL:-0} <= 10#${{ inputs.skip_threshold }} )); then
            echo "skip_review=true" >> $GITHUB_OUTPUT
          else
            echo "skip_review=false" >> $GITHUB_OUTPUT
          fi

      - name: Post skip message
        if: github.event_name == 'pull_request' && steps.pr_size.outputs.skip_review == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `**Claude Code Review Skipped** — only **${{ steps.pr_size.outputs.total_changes }}** lines changed (<= ${{ inputs.skip_threshold }}). Comment \`${{ inputs.trigger_phrase }} review my changes\` to request one.`
            })

      # Automation mode: auto-review on pull_request events.
      # Per official docs: provide REPO, PR NUMBER, gh pr comment instruction, and --allowedTools.
      - name: Claude Code Review (auto-review)
        uses: anthropics/claude-code-action@v1
        if: github.event_name == 'pull_request' && steps.pr_size.outputs.skip_review != 'true'
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Review this PR. Focus on ${{ inputs.review_focus }}.
            Only flag issues introduced by the changes, not pre-existing code.
            If the changes look correct, say so briefly.

            Use `gh pr comment` for top-level feedback.
            Only post GitHub comments — do not submit review text as messages.

          claude_args: |
            --model ${{ inputs.model || vars.CLAUDE_PR_REVIEW_MODEL }}
            --max-turns ${{ inputs.max_turns }}
            --allowedTools "Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(git diff:*),Bash(git log:*),Read,Glob,Grep"

      # Interactive mode: respond to @claude mentions on PRs.
      # Per official docs: no prompt, no --allowedTools — action auto-detects tag mode.
      - name: Claude Code Review (interactive)
        uses: anthropics/claude-code-action@v1
        if: github.event_name == 'issue_comment'
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          trigger_phrase: ${{ inputs.trigger_phrase }}
          claude_args: |
            --model ${{ inputs.model || vars.CLAUDE_PR_REVIEW_MODEL }}
            --max-turns ${{ inputs.max_turns }}
