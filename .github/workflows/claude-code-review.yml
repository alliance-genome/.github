name: Claude Code Review (Reusable)

on:
  workflow_call:
    inputs:
      model:
        description: 'Claude model to use. If empty, falls back to CLAUDE_PR_REVIEW_MODEL org/repo variable.'
        required: false
        default: ''
        type: string
      max_turns:
        description: 'Maximum conversation turns'
        required: false
        default: '10'
        type: string
      review_focus:
        description: 'What to focus the review on'
        required: false
        default: 'critical bugs and database performance'
        type: string
      trigger_phrase:
        description: 'Phrase to trigger manual reviews'
        required: false
        default: '@claude'
        type: string
      # Updated thresholds based on PR analysis
      # Skip 10th percentile is ~2-3 lines, using 3 to be conservative
      skip_threshold:
        description: 'Line count threshold to skip reviews entirely'
        required: false
        default: '3'
        type: string
    secrets:
      ANTHROPIC_API_KEY:
        description: 'Anthropic API key for Claude'
        required: true

jobs:
  claude-review:
    runs-on: ubuntu-latest
    timeout-minutes: 8
    permissions:
      contents: read
      pull-requests: write
      issues: write
      # REQUIRED: Claude Code Action uses OIDC for GitHub authentication
      id-token: write
      # Required for Claude to read CI results on PRs
      actions: read
    if: |
      github.actor != 'pjhale' &&
      github.actor != 'claude[bot]' && (
        github.event_name == 'pull_request' ||
        (github.event_name == 'issue_comment' && contains(github.event.comment.body, inputs.trigger_phrase)) ||
        github.event_name == 'workflow_dispatch'
      )

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Need full history for diff calculation

      - name: Calculate PR size
        id: pr_size
        if: github.event_name == 'pull_request'
        run: |
          set -eo pipefail

          # Validate inputs are integers
          if ! [[ "${{ inputs.skip_threshold }}" =~ ^[0-9]+$ ]]; then
            echo "Error: skip_threshold must be an integer"
            exit 1
          fi

          # Get the base and head commits
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          # Calculate lines added and removed (filter out binary files)
          DIFF_STATS=$(git diff --numstat $BASE_SHA..$HEAD_SHA | grep -E '^[0-9]+\s+[0-9]+' || true)
          TOTAL_CHANGES=$(echo "$DIFF_STATS" | awk '{added+=$1; removed+=$2} END {print added+removed}')

          # Handle empty or malformed output - ensure it's a valid number
          TOTAL_CHANGES=${TOTAL_CHANGES:-0}
          # Validate it's numeric, default to 0 if not
          if ! [[ "$TOTAL_CHANGES" =~ ^[0-9]+$ ]]; then
            echo "Warning: Non-numeric diff result, defaulting to 0"
            TOTAL_CHANGES=0
          fi

          echo "Total lines changed: $TOTAL_CHANGES"
          echo "total_changes=$TOTAL_CHANGES" >> $GITHUB_OUTPUT

          # Determine review strategy based on PR size (safe numeric comparisons)
          # Fix #2: Force base-10 interpretation to prevent octal issues
          if (( 10#$TOTAL_CHANGES <= 10#${{ inputs.skip_threshold }} )); then
            echo "Trivial PR detected (<=${{ inputs.skip_threshold }} lines) - skipping Claude review"
            echo "skip_review=true" >> $GITHUB_OUTPUT
          else
            echo "Standard PR detected (>${{ inputs.skip_threshold }} lines) - using Claude Sonnet review"
            echo "skip_review=false" >> $GITHUB_OUTPUT
          fi

      - name: Post skip message
        if: github.event_name == 'pull_request' && steps.pr_size.outputs.skip_review == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸ¤– **Claude Code Review Skipped**

              This PR has only **${{ steps.pr_size.outputs.total_changes }} lines changed** (<= ${{ inputs.skip_threshold }} lines).

              Claude reviews are automatically skipped for trivial changes to save costs and reduce noise.

              **Need a review anyway?** Comment \`${{ inputs.trigger_phrase }}\` to trigger a manual review.

              ---

              **Review strategy (current thresholds):**
              - **â‰¤ ${{ inputs.skip_threshold }} lines**: Skipped - this PR
              - **> ${{ inputs.skip_threshold }} lines**: Standard Claude Sonnet review

              ---

              ðŸ’¡ **Claude Code Capabilities**

              I can help with more than just reviews! Try these:
              - **Answer Questions**: \`${{ inputs.trigger_phrase }} explain how the caching system works\`
              - **Implement Code Changes**: \`${{ inputs.trigger_phrase }} add error handling to the user login method\`
              - **Debug Issues**: \`${{ inputs.trigger_phrase }} help debug why the search is slow\`
              - **Analyze Architecture**: \`${{ inputs.trigger_phrase }} review the database schema changes\`
              - **Perform another review**: \`${{ inputs.trigger_phrase }} Please review my changes\`

              Just comment \`${{ inputs.trigger_phrase }}\` followed by your request!`
            })

      - name: Count existing bot comments
        id: pre_check
        if: github.event_name != 'pull_request' || steps.pr_size.outputs.skip_review != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.issue?.number || context.payload?.pull_request?.number;
            if (!issueNumber) {
              core.setOutput('baseline_count', '0');
              core.setOutput('issue_number', '0');
              return;
            }
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              per_page: 100
            });
            const botComments = comments.filter(c => c.user.login === 'claude[bot]');
            core.setOutput('baseline_count', String(botComments.length));
            core.setOutput('issue_number', String(issueNumber));
            console.log(`Baseline: ${botComments.length} claude[bot] comments on #${issueNumber}`);

      - name: Claude Code Review
        id: claude_review
        uses: anthropics/claude-code-action@v1
        if: github.event_name != 'pull_request' || steps.pr_size.outputs.skip_review != 'true'
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          trigger_phrase: ${{ inputs.trigger_phrase }}

          # PR-specific prompt with git diff instructions (only for automated PR reviews)
          # For manual @claude triggers, the user's comment is the instruction
          # General review guidance is in --append-system-prompt (applies to ALL event types)
          prompt: |
            ${{ github.event_name == 'pull_request' && format('
            REPO: {1}
            PR NUMBER: {2}

            Review this pull request.

            START by running: git diff origin/{0}...HEAD --name-status
            Then examine the changed lines using: git diff origin/{0}...HEAD

            IMPORTANT: You MUST post your review as a GitHub PR comment using:
            gh pr comment {2} --body "YOUR_REVIEW_HERE"

            Do NOT just output text - you must use the gh command to post your review to the PR.
            ', github.base_ref, github.repository, github.event.pull_request.number) || '' }}

          # CLI arguments (v1 format)
          # --append-system-prompt provides base Alliance instructions for ALL event types
          claude_args: |
            --model ${{ inputs.model || vars.CLAUDE_PR_REVIEW_MODEL }}
            --max-turns ${{ inputs.max_turns }}
            --allowedTools "Bash,Edit,Read,Write,Glob,Grep,LS"
            --append-system-prompt "You are assisting with an Alliance of Genome Resources application.

            REPOSITORY: ${{ github.repository }}
            REVIEW FOCUS: ${{ inputs.review_focus }}

            REVIEW APPROACH:
            1. For code reviews, use git diff to understand what lines changed
            2. For changed functions/methods, read the surrounding context to understand integration
            3. Focus comments on CHANGES, not pre-existing code
            4. Only flag issues INTRODUCED or WORSENED by the changes

            WHEN TO READ BROADER CONTEXT:
            - When a function signature changes (check callers)
            - When a method implementation changes (understand the full method)
            - When new code is added (verify it fits with surrounding code)
            - When imports/dependencies change (check usage)

            REVIEW SCOPE - Only flag issues that are:
            1. Critical bugs that could cause data corruption or system failures
            2. Database performance issues
            3. Breaking changes to existing functionality

            IMPORTANT: Many PRs are small fixes. If the changes look correct, simply say Changes look good.

            Keep reviews concise and actionable. Reference specific line numbers from the diff.

            CRITICAL: You MUST post your review to the PR using gh pr comment. Do not just output text.

            IMPORTANT: Always end your responses with developer usage instructions:

            ---
            Claude Code Capabilities

            I can help with additional commands! Try these:
            - Answer Questions: ${{ inputs.trigger_phrase }} explain how the caching system works
            - Implement Code Changes: ${{ inputs.trigger_phrase }} add error handling to the user login method
            - Debug Issues: ${{ inputs.trigger_phrase }} help debug why the search is slow
            - Analyze Architecture: ${{ inputs.trigger_phrase }} review the database schema changes
            - Perform another review: ${{ inputs.trigger_phrase }} Please review my changes

            Just comment ${{ inputs.trigger_phrase }} followed by your request!"

          # Environment variables via settings (v1 format - replaces claude_env)
          settings: |
            {
              "env": {
                "REPOSITORY": "${{ github.repository }}",
                "ORGANIZATION": "${{ github.repository_owner }}",
                "REVIEW_FOCUS": "${{ inputs.review_focus }}",
                "PR_SIZE": "${{ github.event_name == 'pull_request' && steps.pr_size.outputs.total_changes || 'N/A' }}",
                "REVIEW_SKIPPED": "${{ github.event_name == 'pull_request' && steps.pr_size.outputs.skip_review || 'false' }}"
              }
            }

      - name: Log execution metrics
        if: always() && steps.claude_review.outcome != 'skipped'
        shell: bash
        run: |
          EXEC_FILE="${{ steps.claude_review.outputs.execution_file }}"
          if [ -n "$EXEC_FILE" ] && [ -f "$EXEC_FILE" ]; then
            echo "=== Claude Execution Metrics ==="
            python3 -c "
          import json, sys
          with open('$EXEC_FILE') as f:
              data = json.load(f)
          for key in ['num_turns', 'duration_ms', 'total_cost_usd', 'is_error', 'subtype']:
              if key in data:
                  print(f'{key}: {data[key]}')
          " 2>/dev/null || echo "Could not parse execution file"
          else
            echo "No execution file found (step may have been cancelled)"
          fi

      - name: Verify review posted
        if: always() && steps.claude_review.outcome != 'skipped'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = parseInt('${{ steps.pre_check.outputs.issue_number }}');
            if (!issueNumber) {
              console.log('No issue/PR number found â€” skipping verification');
              return;
            }

            const baselineCount = parseInt('${{ steps.pre_check.outputs.baseline_count }}');
            const reviewOutcome = '${{ steps.claude_review.outcome }}';

            // Count current claude[bot] comments
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              per_page: 100
            });
            const currentBotComments = comments.filter(c => c.user.login === 'claude[bot]');

            console.log(`Baseline: ${baselineCount}, Current: ${currentBotComments.length}, Review outcome: ${reviewOutcome}`);

            if (currentBotComments.length > baselineCount) {
              console.log('Review comment was posted successfully');
              return;
            }

            // No new comment was posted â€” determine the reason and post a fallback
            let body;
            if (reviewOutcome === 'cancelled') {
              body = [
                '**Review Timed Out**',
                '',
                'The Claude Code review exceeded the 8-minute timeout and was cancelled.',
                'This usually means the review was unusually complex or encountered an issue.',
                '',
                'Please try again â€” if this keeps happening, contact the repository maintainers.',
                '',
                '---',
                '*Automated fallback from the Claude Code Review workflow.*'
              ].join('\n');
            } else {
              body = [
                '**Review Incomplete**',
                '',
                'Claude completed execution but did not post a review comment.',
                'This is a known intermittent issue being investigated upstream.',
                '',
                'Please try again â€” if this keeps happening, contact the repository maintainers.',
                '',
                '---',
                '*Automated fallback from the Claude Code Review workflow.*'
              ].join('\n');
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: body
            });

            core.setFailed(`Claude Code Review did not post a comment (outcome: ${reviewOutcome}) â€” fallback message posted`);
